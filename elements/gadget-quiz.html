<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../../polymer/polymer.html">

<!--
Element providing solution to no problem in particular.

##### Example

    <gadget-quiz></gadget-quiz>

@element gadget-quiz
@demo demo/index.html
@status alpha
@homepage http://github.com/tomayac/hyper-video
-->
<dom-module id="gadget-quiz">

  <template>

    <style>
      .quiz-question {
        background-color: black;
        opacity: .7;
        color: white;
        font-family: sans-serif;
        font-size: 1em;
        position: absolute;
        top: 0px;
        left: 0px;
        padding: 1em;
        justify-content: center;
        text-align: center;
        flex-direction: column;
        z-index: 10000;
      }
    </style>

    <div id="container" class="container">
    </div>
  </template>

  <script>
    'use strict';

    Polymer({
      is: 'gadget-quiz',

      properties: {
        src: {
          type: String
        },
      },

      created: function() {
      },

      ready: function() {
        var that = this;
        var container = that.$.container;
        var cuesElements = [];
        var width;
        var height;
        var hypervideo;

        document.addEventListener('hypervideo-loaded-metadata', function(e) {
          console.log('Received event (document): hypervideo-loaded-metadata');
          hypervideo = e.target;
          var data = e.detail;
          width = data.width;
          height = data.height;
        });

        container.addEventListener('click', function(e) {
          if (e.target.nodeName.toLowerCase() !== 'button') {
            return;
          }
          var button = e.target;
          for (var i = 0, lenI = cuesElements.length; i < lenI; i++) {
            var cue = cuesElements[i];
            cue.style.display = 'none';
          }
          hypervideo.seekTo(parseFloat(button.dataset.end) + 0.5);
          hypervideo.play();
        });

        document.addEventListener('cues-read', function(e) {
          console.log('Received event (document): cues-read');
          var data = e.detail;
          if (data.kind !== 'metadata') {
            return;
          }
          var cues = data.cueData;
          cues.forEach(function(cue, i) {
            var div = document.createElement('div');
            div.dataset.start = cue.start;
            div.dataset.end = cue.end;
            div.classList.add('quiz-question', 'style-scope', 'gadget-quiz');
            div.style.display = 'none';
            div.style.width = width + 'px';
            div.style.height = height + 'px';
            div.innerHTML =
                '<div>' +
                  '<p>' + cue.text + '</p>' +
                  '<button data-end="' + cue.end + '">Continue</button>' +
                '</div>';
            container.appendChild(div);
            cuesElements[i] = div;
          });
        });

        document.addEventListener('hypervideo-time-update', function(e) {
          // console.log('Received event (document): hypervideo-time-update');
          var currentTime = e.detail.currentTime;
          for (var i = 0, lenI = cuesElements.length; i < lenI; i++) {
            var cue = cuesElements[i];
            var start = cue.dataset.start;
            var end = cue.dataset.end;
            if (start <= currentTime && currentTime < end) {
              cue.style.display = 'flex';
              e.target.pause();
            } else {
              cue.style.display = 'none';
            }
          }
        });

        setTimeout(function() {
          console.log('Fired event: track-ready');
          that.fire(
            'track-ready',
            {
              src: that.src,
              kind: 'metadata'
            }
          );
        }, 250);
      }
    });
  </script>

</dom-module>
